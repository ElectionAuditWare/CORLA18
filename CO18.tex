%\documentclass[12pt]{article}
\documentclass[runningheads]{llncs}

%\bibliographystyle{plainnat}
\bibliographystyle{splncs04}
\usepackage{graphicx}
\usepackage{amssymb,amsmath,color}
\usepackage[breaklinks=true]{hyperref}
\renewcommand\UrlFont{\color{blue}\rmfamily}

\usepackage[anythingbreaks]{breakurl}
%\usepackage[round]{natbib}
%\usepackage{amsthm}
%\usepackage{algorithm}
%\usepackage{algorithmicx}
%\usepackage[noend]{algpseudocode}
\newtheorem{thm}{Theorem}
%\newtheorem{definition}{Definition}

\newcommand{\beq}{\begin{equation}}
\newcommand{\eeq}{\end{equation}}
\newcommand{\ben}{\begin{enumerate}}
\newcommand{\een}{\end{enumerate}}

\newcommand{\mc}[1]{\ensuremath{\mathcal{#1}}}
\newcommand{\mb}[1]{\ensuremath{\mathbb{#1}}}
\newcommand{\ul}[1]{\ensuremath{\underline{#1}}}
\newcommand{\RM}{\emph{RM}}
\newcommand{\A}{\emph{A}}
\newcommand{\B}{\emph{B}}
\newcommand{\C}{\emph{C}}
\newcommand{\EE}{\bb{E}}
\newcommand{\PP}{\bb{P}}
\newcommand{\bpi}{\bar{\pi}}
\newcommand{\bp}{\bar{p}}

% \newcommand{\comment}[1]{}
\newcommand{\comment}[1]{\textcolor{red}{\sc #1}}



\title{Draft: A New Method for Stratified Risk-Limiting Audits}

\author{
   Kellie Ottoboni\inst{1}\orcidID{0000-0002-9107-3402} \and
   Philip B.~Stark\inst{1}\orcidID{0000-0002-3771-9604} \and
   Mark Lindeman\inst{2}\orcidID{0000-0001-8815-815X} \and
   Neal McBurnett\orcidID{0000-0001-8667-1830} 
}
\authorrunning{K.~Ottoboni et al.}

\institute{
Department of Statistics, University of California, Berkeley, CA, USA \and
Department of Political Science, Columbia University, NY, USA and Verified Voting Foundation}

\date{Version: \today}

\begin{document}
\maketitle


\begin{abstract}
Risk-limiting audits (RLAs) generally rely on random samples of ballots.
Risk calculations are simplest for random samples consisting of individual ballots drawn with replacement from all ballots cast in a contest.
However, stratified sampling --- partitioning the population of ballots into disjoint
strata, and sampling independently from the strata --€”- may simplify logistics or make the audit more efficient.
For instance, Colorado intends to conduct risk-limiting audits of statewide contests and other contests that cross jurisdictional boundaries.
Some Colorado counties (comprising 98.2\% of voters)
have new voting systems that allow auditors to check how the system interpreted each ballot; the rest do not.
%Before this work, the only approaches to combining information
%from all counties into a single RLA either required all counties to 
%use \emph{ballot-polling}, which is not as efficient as \emph{ballot-level comparison}, which only the newer systems support, or to use
%variable batch size comparison audits, which would require exporting data from the older systems in a way that the counties have not yet undertaken, and weighted random sampling, which Colorado's audit software does not support.
Before this work, the only approaches to combining information from all counties into a single RLA
required some counties to use a less efficient method than their equipment allowed.
We provide a simpler approach that is substantially more efficient: 
stratify cast ballots into two groups (ballots cast in counties with newer systems and those cast in counties with legacy system); 
sample from those strata independently; 
apply a generalization of ballot-level comparison auditing in one stratum and of ballot-polling auditing in the other to test the hypothesis that the ``overstatement error'' in each stratum exceeds some threshold; 
then combine the stratum-level results using Fisher's nonparametric combination of tests; maximize the combined $P$-value over all partitions of the error.
This yields a more efficient audit of contests that cross jurisdictional boundaries (including statewide contests and most federal contests) than ballot-polling would give.
The method for combining information from different audit strategies (ballot-polling and comparison) is new.
Moreover, it is more efficient than extant methods for using stratified samples with a single audit strategy
(e.g.,comparison audits in separate strata).
%\comment{Kellie: we need to run a test against the Higgins, Rivest \& Stark method}.
%We also explain how Colorado's current audit software (RLATool) could be extended to support audits of cross-jurisdictional contests. 
%This paper addresses both gaps, along the way introducing a simple, efficient way to use stratified sampling in RLAs.
% (Stratification makes it easier to combine ballot-polling and ballot-level comparison, and also is useful to reduce coordination among jurisdictions required to audit cross-jurisdictional contests.)
We provide an open-source reference implementation of the method and exemplar calculations in Jupyter notebooks.

\keywords{stratified sampling, nonparametric testing, Fisher's combining function, sequential hypothesis tests, Colorado elections}
\end{abstract}

\noindent
\textbf{Acknowledgements.}
We are grateful to Ronald L.~Rivest and Steven N.~Evans for helpful conversations and suggestions.

\section{Introduction}
A risk-limiting audit (RLA) of an election is a procedure that
has a known, pre-specified minimum chance of leading to a full manual tally of the ballots if the electoral outcome of that tally (i.e., the winning candidates or positions, not the exact vote counts) would differ from the
reported outcome. 
RLAs require a durable, voter-verifiable record of voter intent, such as paper ballots,
and they assume that this audit trail is sufficiently complete and accurate that a full hand
tally would show the true electoral outcome.
That assumption is not automatically satisfied: a \emph{compliance audit}
\cite{starkWagner12} 
is required to check whether election accounting and security procedures were followed.

Risk-limiting audits are generally (but not necessarily) incremental: they examine more ballots, or batches of ballots,
until either (i)~there is strong statistical evidence that a full hand tabulation would confirm the outcome,
or (ii)~the audit has led to a full hand tabulation, the result of which should become the official
result.

%RLAs have been piloted in California, Colorado, and Ohio, and a test of
%RLA procedures has been conducted in Arizona.
%RLA bills are being drafted or are already under consideration in California,
%Virginia, Washington, and other states.
%A number of laws have either allowed or mandated risk-limiting audits,
%including California AB~2023 (Salda\~{n}a), SB~360 (Padilla), and AB~44 (Mullin);
%Rhode Island SB~413A and HB~5704A; and Colorado Revised Statutes (CRS)~1-7-515.
%At the time of writing, California is considering another RLA bill, AB~2125.

%CRS~1-7-515 requires 
%Colorado to conduct risk-limiting audits beginning in 2017.
%(There are provisions to allow the Secretary of State to exempt some counties.)
%The first set of coordinated risk-limiting election audits across the state took place in Colorado in November, 2017.\footnote{%
% See \url{https://www.sos.state.co.us/pubs/elections/RLA/2017RLABackground.html}
%}
%Those audits only covered contests restricted to a single county:
%counties could audit independently.
%To audit statewide elections and contests that cross county lines, Colorado will need to implement new approaches
%and modify RLATool\footnote{%
%  \url{https://github.com/FreeAndFair/ColoradoRLA/}
%}, 
%the open-source audit software used for their 2017 audits. 

% \comment{confirm or correct these assertions} They are not correct. PBS
%State laws mandating risk-limiting audits generally require a simple random sample of ballots from each contest to be audited.
%This is feasible when contests are contained within a single jurisdiction, where elections officials can deal with ballots locally.
%However, the logistics of drawing a simple random sample of ballots that cross jurisdiction lines are more difficult.
%This would require a central agency to determine which ballots each jurisdiction should draw, and then each jurisdiction must report the results of their audit back to the central agency to be combined.

The most efficient, transparent, and statistically tractable sampling design for risk-limiting audits is to sample individual ballots uniformly at random from the ballots cast in the contest, with or without replacement.
However, to audit contests that cross jurisdictional boundaries then requires coordinating sampling in different counties, and may require different counties to use the lowest-common denominator risk calculations, e.g. ballot-polling, described below. 

Thus, it may be more tractable logistically to use a stratified sample, selecting ballots independently from different counties or groups of counties. 
Stratification may also be useful within counties, for instance, to allow auditors to sample independently from ballots cast in person, by mail, and provisionally.

While stratified RLAs have been considered previously \cite{stark08a,higginsEtal11}, the methods addressed only a single approach to auditing, batch-level comparisons, and only a particular test statistic.

This paper introduces a more general approach to using stratified samples in RLAs.
The approach involves finding a ``worst case'' $P$-value over one or more nuisance parameters.
For each value of the nuisance parameters, Fisher's combining function is used to combine independent $P$-values from the strata. 
Conceptually, the procedure considers every possible partition of outcome-changing error across the strata, and calculates the largest
$P$-value across all such partitions, using Fisher's combining function.
If the maximum $P$-value is less than the risk limit, the audit can stop;
otherwise, the audit must inspect more ballots.

In practice, it is not necessary to consider all possible partitions the allowable error across strata, because the $P$-value is a simple combination of monotonic functions.
We present a numerical procedure (with a Python implementation)
to find upper bounds on the maximum $P$-value when there are two strata.
The procedure can be generalized to more than two strata.


\subsection{Voting systems and audit strategies}

Voting systems that export cast vote records (CVRs) are auditable at the ballot level: 
those systems record votes in a manner that allows the corresponding paper ballot to be identified,
and conversely, make it possible to find the CVR corresponding to any
particular paper ballot.
We call counties that have such systems ``CVR'' counties.
%It is estimated that by June, 2018, 98.2\% of active Colorado voters will be in CVR counties.
CVR counties can perform \textit{ballot-level comparison audits},'' \cite{lindemanStark12} 
which are currently the most efficient approach to risk-limiting audits in that they require examining fewer
ballots than other methods do, when the outcome of the contest under audit 
is in fact correct.
Ballot-level comparison audits involve comparing a human reading of individual ballots to the machine-constructed CVRs for the same ballots.

Voting systems in other counties (``legacy'' or ``no-CVR'' counties) 
do not allow auditors to check how the system interpreted voter intent for individual ballots.
Election results involving those counties can still be audited, provided the voting systems
create a voter-verifiable paper trail (e.g., voter-marked paper ballots) that is
conserved to ensure that it remains accurate and intact, and organized well enough
to permit ballots to be selected at random.
\textit{Ballot-polling audits} \cite{lindemanEtal12,lindemanStark12} can be used to test whether the vote proportions 
found by hand-counting a simple random sample of ballots differ significantly enough from what was reported
to change the election outcome. 
Ballot-polling audits require examining more ballots than ballot-level comparison audits.

There is currently no literature on how to combine
ballot polling and ballot-level comparisons in a single risk-limiting audit.
Existing methods either would require all counties to use the lowest
common denominator (ballot-polling, which does not take advantage of the CVRs,
and thus is expected to require more auditing than a method that uses the available CVRs),
 or would require no-CVR counties to perform \textit{batch-level comparisons}
 (auditing entire groups of ballots that can be retrieved and counted manually,
 for which the vote subtotals were recorded), which were found in
California to be less efficient than ballot-polling audits \cite{CA_SOS_EAC}.%
\footnote{%
  See~\cite{Rivest-2018-bayesian-tabulation-audits}
  for a different (Bayesian) approach to auditing contests that include both CVR counties
  and no-CVR counties. In general, Bayesian audits are not risk-limiting.
}

We use our new approach to stratification to show
how contests that cross jurisdictional boundaries (\textit{cross-jurisdictional contests}, such as gubernatorial contests, statewide ballot measures, and
many federal contests) can be audited efficiently when some of the jurisdictions can perform ballot-level comparison audits
and the others can only perform ballot-polling audits.
This has an immediate application in Colorado, where state law requires
risk-limiting audits.
As of July, 2018, Colorado has not performed a risk-limiting audit of a cross-jurisdictional contest.

Section~\ref{sec:stratified} presents the new method for stratified audits
based on combining $P$-values in different strata.
We show how the method allows ballot-polling auditing in one 
stratum to be combined with ballot-level comparison auditing in another.
Next, Section~\ref{sec:combiningMethods} specializes the stratified audit approach to handle heterogeneous voting equipment.
Sections~\ref{sec:comparisonError} and~\ref{sec:ballotPollError} explain
the necessary modifications to ballot-level comparison and ballot-polling, respectively,
to construct within-stratum hypothesis tests about the amount of \textit{overstatement error},
errors which increases the apparent margin between reported winners and losers. 
Section~\ref{sec:examples} gives numerical examples of these approaches in simulated audits,
using Colorado as an example use case.
We provide example software implementing the risk calculations for
our recommended approach in a Python Jupyter notebook.\footnote{%
 See \url{https://github.com/pbstark/CORLA18}.
}
Section~\ref{sec:discussion} gives recommendations and
considerations for implementation.


\section{Stratified audits} \label{sec:stratified}

\emph{Stratified sampling} involves partitioning the cast ballots
into non-overlapping groups and sampling independently from those groups.
\cite{stark08a,higginsEtal11} discuss stratified sampling in batch-level comparison audits.
The method we develop here works generally to construct a RLA using stratified sampling.

Here and generally throughout the paper, we 
discuss auditing a single plurality contest at a time, although the same sample can be used to audit
more than one contest (and super-majority contests), and there are ways of combining audits of different contests into
a single process \cite{stark09c,stark10d}.
We use terminology drawn from a number of papers; the key reference is Lindeman and Stark, 2012~\cite{lindemanStark12}.
An \emph{overstatement error} is an error that caused the margin between \emph{any} reported
winner and \emph{any} reported loser to appear larger than it really was.
An \emph{understatement error} is an error that caused the margin between \emph{every} reported
winner and \emph{every} reported loser to appear to be smaller than it really was.

Throughout, we will refer to a contest between reported winner $w$ and reported loser $\ell$.
The total number of reported votes for candidate~$w$ is denoted $V_w$ 
and the total for candidate~$\ell$ is denoted $V_\ell$, so that $V_w > V_\ell$, since 
$w$ is the reported winner.

Let $V_{w\ell} > 0$ denote the contest-wide margin (in votes) of reported winner 
$w$ over reported loser $\ell$.
Suppose that we have two strata indexed $s=1, 2.$
Let $V_{w\ell,s}$ denote the margin (in votes) of reported winner $w$ over reported loser $\ell$
in stratum $s$. 
Note that $V_{w\ell,s}$ could be negative in one stratum.
Let $A_{w\ell}$ denote the margin (in votes)
of reported winner $w$ over reported loser $\ell$ that 
a full hand count of the entire contest would show, that is, the \emph{actual} margin rather
than the \emph{reported} margin.
Reported winner $w$ really beat reported loser $\ell$ if and only if $A_{w\ell} > 0$.
Define $A_{w\ell,s}$ to be the actual margin (in votes) of $w$ over $\ell$ in stratum $s$;
this too may be negative.

Let $\omega_{w\ell,s} \equiv V_{w\ell,s} - A_{w\ell,s}$ be the \emph{overstatement}
of the margin of $w$ over $\ell$ in stratum $s$.
Reported winner $w$ really beat reported loser 
$\ell$ if and only if $\omega_{w\ell} \equiv \omega_{w\ell,1} + \omega_{w\ell,2} < V_{w\ell}$.

The null hypothesis $\omega_{w\ell, 1} + \omega_{w\ell, 2} \ge V_{w\ell}$ is true if and only if there exists \textit{some} $\lambda \in \Re$ such that 
$\omega_{w\ell, 1}\ge \lambda V_{w\ell}$ and 
$\omega_{w\ell, 2}\ge (1-\lambda) V_{w\ell}$.\footnote{%
  Set $\lambda = \frac{\omega_{w\ell, 1}}{\omega_{w\ell, 1}+\omega_{w\ell, 2}}$.
}
If, for all $\lambda$, we can reject the hypothesis that the 
overstatement error in stratum~1 is greater than or equal to $\lambda V_{w\ell}$ \emph{and} 
the overstatement error in stratum~2 is greater than or equal to $(1-\lambda) V_{w\ell}$, then
we can conclude that the outcome is correct.
(The approach generalizes to $S$ strata: if there is no tuple $( \lambda_s )_{s=1}^S$ such that
$\sum_s \lambda_s = 1$ and $\omega_s \ge \lambda_s V_{w\ell}$ for all $s$, then
the outcome is correct.)

\subsection{Fisher's combination method}

To test the conjunction hypothesis that both stratum null hypotheses are true, we use 
Fisher's combining function.
Let $p_s(\lambda_s)$ be the $P$-value of the hypothesis $\omega_{w\ell,s} \ge \lambda_s V_{w\ell}$.
Define $\lambda_1 \equiv \lambda$ and $\lambda_2 \equiv 1-\lambda$.
If the null hypothesis that $\omega_{w\ell,1} \ge \lambda_1 V_{w\ell}$ and 
$\omega_{w\ell,2} \ge \lambda_2 V_{w\ell}$ is true, then 
\beq \label{eq:fisher}
   \chi(\lambda_1, \lambda_2) = -2 \sum_{s=1}^2 \ln p_s(\lambda_s)
\eeq
has a probability distribution that is dominated by the chi-square distribution with 4~degrees
of freedom.\footnote{%
   If the two tests had continuously distributed $P$-values, the distribution would be exactly
   chi-square with 4~degrees of freedom, but if either $P$-value has atoms when
   the null hypothesis is true, it is in general stochastically smaller.
   This follows from a coupling argument along the lines of Theorem~4.12.3 in \cite{grimmett01}.
}
Fisher's combined statistic will tend to be small when both null hypotheses are true.
If either is false, then as the sample size increases, Fisher's combined statistic will tend to grow.

If, for all $\lambda_1$ and $\lambda_2 = 1- \lambda_1$, we can reject the conjunction
hypothesis at level $\alpha$, the audit can stop.
The stratified audit thus involves examining more randomly selected ballots from the two strata until 
either the minimum value Fisher's combined statistic over all $\lambda$ 
is larger than the $1-\alpha$ quantile of the chi-square
distribution with 4~degrees of freedom, or until both strata have been fully hand tabulated.

$p_s(\lambda)$ could be a $P$-value for the hypothesis
$\omega_{w\ell,s} \ge \lambda_s V_{w\ell}$ from any test procedure (although
if the audit is to be sequential, the tests in the two strata must be sequential tests or
some other method must be used to account for multiplicity). 
We assume, however, that $p_s$ is based on a one-sided test, and that the tests
for different values of $\lambda$ ``nest'' in the sense that if $a > b$,
then $p_s(a) > p_s(b)$.
This monotonicity is a reasonable requirement because the evidence that the overstatement
is greater than $a$ should be weaker than the evidence that the overstatement is greater than
$b$, if $a > b$.
In particular, this monotonicity holds for the tests proposed in sections~\ref{sec:comparisonError}
and \ref{sec:ballotPollError}.

One could use another function besides Equation~\ref{eq:fisher} to combine $P$-values.
Combining functions must satisfy the following properties \cite{pesarinSalmaso10}:
\begin{itemize}
\item the function must be non-increasing in each argument and symmetric with respect to rearrangements of the arguments;
\item the combining function must attain its supremum when one of the arguments approaches zero;
\item and for every level $\alpha$, the critical value of the combining function is finite and strictly smaller than the function's supremum.
\end{itemize}
Other combining functions include Liptak's combining function, $T = \sum_i \Phi^{-1}(1-p_i)$,
and Tippett's combining function, $T = \max_i (1-p_i)$.

Fisher's combining function is convenient for this application because the tests in different strata are statistically independent,
 so analytic formulas based on the chi-squared distribution can be used to calibrate the distribution of $\chi(\lambda_1, \lambda_2)$. 
If the tests across strata were correlated, the distribution of the combination function would need to be calibrated by simulation and another combining function might have better properties \cite{pesarinSalmaso10}.



\subsection{Maximizing Fisher's combined $P$-value}
The audit can stop if the maximum of Fisher's combined $P$-value over all
$\lambda$ is not larger than $\alpha$, the risk limit.
For a given set of audit data, 
finding the maximum $P$-value over all $\lambda$
is a one-dimensional optimization problem, but the objective function is not necessarily concave.
We need a computational strategy to ensure that the maximum is small
without evaluating the $P$-value for all $\lambda$.

The approach embodied in the software we provide uses a grid search, refining the
grid once the maximum has been bracketed.
This is not guaranteed to find the global maximum exactly, although it can approximate 
the maximum as closely as one desires, by refining the mesh.

A more rigorous approach is to find bounds on Fisher's combining function for all
$\lambda$. 
(Lower bounds translate directly into an upper bound on the $P$-value as a function of
$\lambda$: if the lower bound is 
everywhere larger than the $1-\alpha$ quantile of the chi-squared distribution with 4~degrees of freedom, the maximum $P$-value is no larger than $\alpha$.)
Let $\lambda_-$ be the smallest possible value of $\lambda$ and $\lambda_+$ be the largest
possible value of $\lambda$.
Some values of $\lambda$ can be ruled out \emph{a priori}, because (for instance) $\omega_{w\ell,s} \le
V_{w\ell,s}+N_s$,
where $N_s$ is the number of ballots cast in stratum $s$, and thus
\beq
   1 - \frac{V_{w\ell,2}+N_2}{V_{w\ell}} \le \lambda \le \frac{V_{w\ell,1}+N_1}{V_{w\ell}}.
\eeq
Recall that $p_s(\cdot)$ increases monotonically in its argument, so $p_1(\lambda)$ is
monotonically increasing in $\lambda$ and $p_2(1-\lambda)$ is monotonically decreasing in $\lambda$.
Suppose $[a, b) \subset [\lambda_-, \lambda_+]$.
Then for all $\lambda \in [a, b)$, $-2\ln p_1(\lambda) \ge -2\ln p_1(b)$ and
$-2\ln p_2(1-\lambda) \ge -2\ln p_2(1-a)$.
Thus
\beq
   \chi(\lambda) = -2(\ln p_1(\lambda)+ \ln p_2(1-\lambda))
          \ge -2(\ln p_1(b) + \ln p_2(1-a)) \equiv \chi_-[a,b).
\eeq
This gives a (constant) lower bound for $\chi$ on the interval $[a, b)$; the corresponding 
upper bound is $\chi(\lambda) \le -2(\ln p_1(a) + \ln p_2(1-b)) \equiv \chi_+[a,b)$.
Partitioning $[\lambda_-, \lambda_+]$ into a collection of intervals $[a_k, a_{k+1})$
and finding $\chi_-[a_k, a_{k+1})$ and $\chi_+[a_k, a_{k+1})$ for each
yields piecewise-constant lower and upper bounds for $\chi(\lambda)$; if,
 for all $\lambda \in [\lambda_-, \lambda_+]$, the lower bound
is larger than the $1-\alpha$ quantile of the chi-square distribution with 4~degrees of freedom,
the audit can stop; if the upper bound is anywhere less than the $1-\alpha$ quantile of the chi-square distribution with 4~degrees of freedom, the sample size in one or both strata needs to be larger.

%\comment{discussion of how to escalate: refine the mesh before adding new samples!}


\section{Strategies for auditing heterogeneous voting systems}\label{sec:combiningMethods}
The stratified auditing method in Section~\ref{sec:stratified} solves the problem of auditing contests
for which ballots were cast using heterogeneous voting equipment.
This is the case in Colorado, where most ballots are cast in precincts with equipment that produces CVRs,
but a small fraction are not.


CRS~1-7-515 requires Colorado to conduct risk-limiting audits beginning in 2017.
%(There are provisions to allow the Secretary of State to exempt some counties.)
The first set of coordinated risk-limiting election audits across the state took place in Colorado in November, 2017.\footnote{%
 See \url{https://www.sos.state.co.us/pubs/elections/RLA/2017RLABackground.html}
}
Those audits only covered contests restricted to a single county:
counties could audit independently.
Colorado's ``uniform voting system'' program\footnote{%
  \url{https://www.sos.state.co.us/pubs/elections/VotingSystems/UniformVotingSystem.html}
} 
led many Colorado counties to purchase (or to plan to purchase) voting systems
that export CVRs, and thus can be audited using ballot-level comparisons.
It is estimated that by June, 2018, 98.2\% of active Colorado voters will be in CVR counties.
These counties cannot audit ballots independently:
margins and risk limits apply to entire contests, not to the portion of a contest included in a county.
To audit statewide elections and contests that cross county lines, Colorado will need to implement new approaches
that account for heterogeneous voting equipment.

Several auditing strategies could be used in Colorado.
The first approach is to use ballot-polling audits for all cross-jurisdictional contests.
This would not take advantage information provided by CVRs and would 
increase the workload disproportionately in the CVR counties.

Another approach is to perform a comparison audit across all counties, but to use batches consisting
of more than one ballot (and to perform batch-level comparisons)
in legacy counties and batches consisting of a single ballot (and to perform ballot-level comparisons) in CVR counties.\footnote{%
 For majority and plurality elections, including those in which voters can select more than one candidate,
  audits can be based on overstatement and understatement errors at the level of batches.
}

However, Colorado's software would need to be modified in order to allow sampling batches with
unequal probabilities and to calculate risk appropriately.
The mathematical details for calculating
batch-level error bounds, drawing the samples with probability proportional to an
error bound, and calculating the attained risk from the sample results are worked out
in published papers \cite{stark09c,stark09b,stark10d} and in Section~\ref{sec:appendix-comparison}.
Indeed, this is the method that was used in several of California's pilot audits,
including the audit in Orange County.

Moreover, this approach requires that the no-CVR counties report vote subtotals
for physically identifiable batches.
If a county's voting system can only report subtotals by precinct but 
the county does not sort paper ballots by
precinct, this approach might require revising how the county handles its
paper.

Finally, the stratified audit approach from Section~\ref{sec:stratified} can solve the problem of auditing in CVR and no-CVR counties.
Every ballot cast in the contest is in exactly one of two strata, CVR counties and no-CVR counties. 
The CVR counties would conduct a ballot-level comparison audit while the
legacy counties independently conduct a ballot-polling audit, to then be combined by a central organization.
This approach does not unduly increase the workload in CVR counties
to compensate for legacy equipment, nor does it force the legacy counties
to audit entire batches of ballots.

In order to use Equation~\ref{eq:fisher}, we must develop tests for the overstatement error that are appropriate for the
corresponding voting system.
Sections~\ref{sec:comparisonError} and~\ref{sec:ballotPollError} describe these tests for overstatement in the CVR and no-CVR strata,
respectively.

Of these methods, stratified ``hybrid'' audits seem the most palatable,
given the constraints on time for software development and the logistics
of the audit itself. 
The workflow for counties would be the same as it was in November, 2017.
Simulations suggest that this approach is relatively efficient.


%\input{comparisonError}
\subsection{Batch comparison audits of a tolerable overstatement in votes}
\label{sec:comparisonError}

Previous methods for comparison auditing must be modified to handle two new requirements.  
The first relates to partitioning the permissible overstatement
through the parameters $\lambda_s$, as discussed in Section~\ref{sec:stratified}. 
The second handles batch-level comparison audits.

For this framework, we'd like to test whether the overstatement of any margin
(in votes) exceeds some fraction $\lambda$ of the overall margin $V_{w\ell}$ between
reported winner $w$ and reported loser $\ell$.
If the stratum contains all the ballots cast in the contest, then for $\lambda = 1$, this 
would confirm the election outcome.
For stratified audits, we must test other values of $\lambda$, as described in Section~\ref{sec:stratified}.

We address the second requirement by deriving a method for batches of arbitrary size, which might be useful
 to audit contests that include CVR counties and legacy counties.
This modification comes from changing the assumed upper bound on the possible overstatement in batches.
We keep the \emph{a priori} error bounds tighter than the ``super-simple'' 
method~\cite{stark10d}.
To keep the notation simpler, we consider only a single contest, but the 
MACRO test statistic \cite{stark09c,stark10d} automatically extends the result to 
auditing $C>1$ contests simultaneously.
The derivation is for plurality contests, including ``vote-for-$k$'' plurality contests.
Majority and super-majority contests are a minor 
modification~\cite{stark08a}.\footnote{%
  So are some forms of preferential and approval voting, such as Borda count, and
  proportional representation contests, such as D'Hondt~\cite{starkTeague14}.
  See \url{https://github.com/pbstark/S157F17/blob/master/audit.ipynb} for a derivation
  of ballot-level comparison risk-limiting audits for super-majority contests. (Last visited 14 May 2018.)
  Changes for IRV/STV are more complicated.
}

The mathematical derivations are in Appendix~\ref{sec:appendix-comparison}.



%\input{ballotPollError}
\subsection{Ballot-polling audits of a tolerable overstatement in votes}
\label{sec:ballotPollError}

In in Appendix~\ref{sec:appendix-polling},
 we develop a new method for ballot-polling audits that can test numerical margins,
rather than just test whether a candidate won.
This requires a different approach than that taken by \cite{lindemanEtal12}.

Existing ballot-polling methods consider only the fraction of ballots with a vote for either 
$w$ or $\ell$ that contain a vote for $w$,
making the statistical test one for a proportion.
To allow the error to be partitioned across the strata via $\lambda_s$,
the necessary inference is about the 
\emph{difference} between the number of votes for $w$ and the number of votes for $\ell$.
This introduces a nuisance parameter, the number of ballots with votes for either $w$ or $\ell$.
We deal with the nuisance parameter by maximizing the $P$-value 
over all possible values of the nuisance parameter, which ensures that the test is conservative.

\section{Numerical examples}\label{sec:examples}

%\comment{explain hypothetical elections, what we're comparing to}

Examples of stratified hybrid audits, like what could be used in Colorado, are in Jupyter notebooks available
at \url{https://www.github.com/pbstark/CORLA18}.

The first example, in \texttt{hybrid-audit-example-1}, is a hypothetical medium-sized election with 
$110,000$ ballots cast, of which 
9.1\% were cast in no-CVR counties. 
The diluted margin is $1.8\%$.
In 95 of 100 simulations, a stratified ``hybrid'' audit at risk limit 10\% with sample sizes of 500 ballots 
in the CVR stratum and 700 ballots in the no-CVR stratum
(1,200 ballots in all)
would have sufficed to confirm the outcome, if the reported results were correct.

In contrast, an unstratified ballot-level comparison audit with risk limit 10\% could have terminated
after examining 263~ballots if it found no errors, and a ballot-polling audit of the entire contest 
would have been expected to examine about 14,000 ballots, more than 10\% of ballots cast.
The hybrid audit is thus not as efficient as a ballot-level comparison audit, but far more efficient than
a ballot-polling audit.
%
%Another conservative method, discussed in Section~\ref{sec:two-vote-over},
%involves conducting a ballot-level comparison audit statewide,
%treating any ballot selected from the no-CVR county as if it had a two-vote overstatement.
%In this numerical example, that method would lead to a full hand count.

The second example, also in \texttt{hybrid-audit-example-1}, 
is a hypothetical large statewide election with 
2~million ballots cast, of which 5\% were cast in no-CVR counties.
The contest has a diluted margin of nearly $20\%$ and the risk limit is 5\%.
The workload for a hybrid stratified audit is quite low:
In 98\% of 10,000 simulations, auditing 43 ballots from the 
CVR stratum and 20 ballots from the no-CVR stratum
would have sufficed to confirm the outcome at a 5\% risk limit.

If it were possible to conduct a ballot-level comparison audit for the entire contest, 
an audit at risk limit 5\% could terminate after examining 31~ballots if it found no errors.
The additional work needed to do the hybrid stratified audit falls mainly in the no-CVR stratum.

A second notebook, \texttt{hybrid-audit-example-2}, illustrates the 
workflow for conducting a hybrid stratified audit of an election with 2~million ballots cast.
The reported margin is just over $1\%$, but the reported winner
and reported loser are actually tied in both strata.  
The risk limit is 5\%.
We use Fisher's method to combine the audits in the CVR stratum (sample size 500) 
and no-CVR stratum (sample size 1000).
The maximum Fisher's combined $P$-value is over 20\%, so the audit cannot stop at that point.



\section{Discussion} \label{sec:discussion}

We have developed a general procedure for auditing stratified random samples.
Previous methods for auditing stratified random samples of ballots were tailored to comparison audits.
Our proposed method is more flexible, in that it allows for different hypothesis tests in each stratum.
Thus, it can be applied to a variety of situations where stratified random sampling is appropriate:
sampling ballots independently from several counties,
or even from different groups of ballots within a county.
To our knowledge, Fisher's combination method has not been used to combine independent audits before.

Furthermore, we have presented a case study in using the proposed stratified method to audit cross-jurisdictional
contests in which some jurisdictions use voting equipment that can export a CVR and some jurisdictions use 
legacy equipment.
The accompanying Jupyter notebooks can be modified and run with different contest sizes, margins, and risk limits to
estimate the workload in different scenarios.
The statistical constraints on the two sample sizes are weak: increasing the
sample size in one stratum generally allows the other sample size to be decreased.
In general, when the contest outcome is correct, the total workload will be minimized by 
assigning a disproportionately large (compared to the number of ballots cast) amount of 
the work to the CVR stratum.
In our numerical experiments, the proposed stratification method greatly reduced the number of ballots needed
to confirm the reported contest outcome compared to other auditing approaches.


\appendix
\section{Ballot comparison derivation}\label{sec:appendix-comparison}
\subsection{Notation}
\begin{itemize}
    \item  $\mathcal{W}$: the set of reported winners of the contest
    \item  $\mathcal{L}$: the set of reported losers of the contest
    \item  $N_s$ ballots were cast in all in the stratum. (The contest might not appear on all $N_s$ ballots.)
    \item  $P$ ``batches'' of ballots are in stratum $s$. A batch contains one or more ballots. Every ballot in stratum $s$ is in exactly one batch.
    \item  $n_p$: number of ballots in batch $p$. $N_s = \sum_{p=1}^P n_p$.
    \item  $v_{pi} \in \{0, 1\}$: the reported votes for candidate $i$ in batch $p$
    \item  $a_{pi} \in \{0, 1\}$: actual votes for candidate $i$ in batch $p$. 
                  If the contest does not appear on any ballot in batch $p$, then $a_{pi} = 0$.
                  
    \item  $V_{w\ell,s} \equiv \sum_{p=1}^P (v_{pw} - v_{p\ell})$: 
Reported margin in stratum $s$ of reported winner $w \in \mathcal{W}$ over reported loser 
$\ell \in \mathcal{L}$, in votes.

    \item  $V_{w\ell}$: 
Overall reported margin of reported winner $w \in \mathcal{W}$ over reported loser 
$\ell \in \mathcal{L}$, in votes, for the entire contest (not just stratum $s$)

    \item  $V$: smallest reported overall margin between any reported winner and reported loser:
$V \equiv \min_{w \in \mathcal{W}, \ell \in \mathcal{L}} V_{w \ell}$

    \item  $A_{w\ell,s} \equiv \sum_{p=1}^P (a_{pw} - a_{p\ell})$: 
actual margin in the stratum of reported winner $w \in \mathcal{W}$ over reported loser 
$\ell \in \mathcal{L}$, in votes

    \item  $A_{w\ell}$: 
actual margin of reported winner $w \in \mathcal{W}$ over reported loser 
$\ell \in \mathcal{L}$, in votes, for the entire contest (not just in stratum $s$)

\end{itemize}


\subsection{Reduction to maximum relative overstatement}
If the contest is entirely contained in stratum $s$, then
the reported winners of the contest are the actual winners if
$$ 
   \min_{w \in \mathcal{W}, \ell \in \mathcal{L}} A_{w\ell,s} > 0.
$$
Here, we address the case that the contest may include a portion outside the stratum.
To combine independent samples in different strata, it is convenient
to be able to test whether the net overstatement error in a stratum exceeds a given threshold.

Instead of testing that condition directly, we will test a condition that is sufficient 
but not necessary for the inequality to hold, to get a computationally simple test that
is still conservative (i.e., the risk is not larger than its nominal value).

For every winner, loser pair $(w, \ell)$, we want to test
whether the overstatement error exceeds some threshold, generally
one tied to the reported margin between $w$ and $\ell$.
For instance, for a stratified hybrid audit, we set the threshold to be
$\lambda_s V_{w\ell}$.

We want to test whether
$$
   \sum_{p=1}^P (v_{pw}-a_{pw} - v_{p\ell} + a_{p\ell})/V_{w\ell} \ge \lambda_s.
$$
The maximum of sums is not larger than the sum of the maxima; that is,
$$
\max_{w \in \mathcal{W},  \ell \in \mathcal{L}}
   \sum_{p=1}^P (v_{pw}-a_{pw} - v_{p\ell} + a_{p\ell})/V_{w\ell}
   \le
  \sum_{p=1}^P  \max_{w \in \mathcal{W},  \ell \in \mathcal{L}} 
  (v_{pw}-a_{pw} - v_{p\ell} + a_{p\ell})/V_{w\ell}.
$$

Define 
$$
  e_p \equiv \max_{w \in \mathcal{W} \ell \in \mathcal{L}} 
     (v_{pw}-a_{pw} - v_{p\ell} + a_{p\ell})/V_{w\ell}.
$$
Then no reported margin is overstated by a fraction $\lambda_s$ or more
if 
$$ 
  E \equiv \sum_{p=1}^P e_p < \lambda_s.
$$

Thus if we can reject the hypothesis $E \ge \lambda_s$, we can conclude that
no pairwise margin was overstated by as much as a fraction $\lambda_s$.

Testing whether $E \ge \lambda_s$ would require a very large sample if we knew nothing at
all about $e_p$ without auditing batch $p$: a single large value of $e_p$ could make
$E$ arbitrarily large.
But there is an \emph{a priori} upper bound for $e_p$.
Whatever the reported votes $v_{pi}$ are in batch~$p$, we can find the
potential values of the actual votes $a_{pi}$ that would make the
error $e_p$ largest, because $a_{pi}$ must be between 0 and $n_p$,
the number of ballots in batch~$p$:
$$
    \frac{v_{pw}-a_{pw} - v_{p\ell} + a_{p\ell}}{V_{w\ell}} \le 
    \frac{v_{pw}- 0 - v_{p\ell} + n_p}{V_{w\ell}}.
$$
Hence,
\begin{equation} \label{eq:uDef}
    e_p \le \max_{w \in \mathcal{W}, \ell \in \mathcal{L}} 
    \frac{v_{pw} - v_{p\ell} + n_p}{V_{w\ell}} \equiv u_p.
\end{equation}

Knowing that $e_p \le u_p$ might let us conclude reliably that $E < \lambda_s$
by examining only a small number of batches---depending on the 
values $\{ u_p\}_{p=1}^P$ and on the values of $\{e_p\}$ for the audited batches.

To make inferences about $E$, it is helpful to work with the \emph{taint} 
$t_p \equiv \frac{e_p}{u_p} \le 1$.
Define $U \equiv \sum_{p=1}^P u_p$.
Suppose we draw batches at random with replacement, with probability $u_p/U$
of drawing batch $p$ in each draw, $p = 1, \ldots, P$.
(Since $u_p \ge 0$, these are all positive numbers, and they sum to 1,
so they define a probability distribution on the $P$ batches.)

Let $T_j$ be the value of $t_p$ for the batch $p$ selected in the $j$th draw.
Then $\{T_j\}_{j=1}^n$ are IID, $\mathbb{P} \{T_j \le 1\} = 1$, and
$$
  \mathbb{E} T_1 = \sum_{p=1}^P \frac{u_p}{U} t_p =
  \frac{1}{U}\sum_{p=1}^P u_p \frac{e_p}{u_p} = 
  \frac{1}{U} \sum_{p=1}^P e_p = E/U.
$$
Thus $E = U \mathbb{E} T_1$. 
So, if we have strong evidence that
$\mathbb{E} T_1 < \lambda_s/U$, we have
strong evidence that $E < \lambda_s$.

This approach can be simplified even further by noting that $u_p$ has
a simple upper bound that does not depend on $v_{pi}$.
At worst, the reported result for batch $p$ shows $n_p$ votes for the 
``least-winning'' apparent winner of the contest with the smallest margin, 
but a hand interpretation would show that all $n_p$ ballots in the batch 
had votes for the runner-up in that contest.
Since $V_{w\ell} \ge V\equiv \min_{w \in \mathcal{W}, \ell \in \mathcal{L}} V_{w \ell}$ and $0 \le v_{pi} \le n_p$,
$$ 
    u_p =  \max_{w \in \mathcal{W}, \ell \in \mathcal{L}} 
    \frac{v_{pw} - v_{p\ell} + n_p}{V_{w\ell}}
    \le  \max_{w \in \mathcal{W}, \ell \in \mathcal{L}} 
    \frac{n_p - 0 + n_p}{V_{w\ell}}
    \le \frac{2n_p}{V}.
$$
Thus if we use $2n_p/V$ in lieu of $u_p$, we still get conservative results.
(We also need to re-define $U$ to be the sum of those upper bounds.)
An intermediate, still conservative approach would be to use this upper bound for
batches that consist of a single ballot, but use the sharper bound (\ref{eq:uDef})
when $n_p > 1$.
Regardless, for the new definition of $u_p$ and $U$,
$\{T_j\}_{j=1}^n$ are IID, $\mathbb{P} \{T_j \le 1\} = 1$,
and
$$
  \mathbb{E} T_1 = \sum_{p=1}^P \frac{u_p}{U} t_p =
  \frac{1}{U}\sum_{p=1}^P u_p \frac{e_p}{u_p} = 
  \frac{1}{U} \sum_{p=1}^P e_p = E/U.
$$

So, if we have evidence that $\mathbb{E} T_1 < \lambda_s/U$, we have evidence that 
$E < \lambda_s$.

\subsection{Testing $\mathbb{E} T_1 \ge \lambda_s/U$}

A variety of methods are available to test whether $\mathbb{E} T_1 < \lambda_s/U$.
One particularly ``clean'' sequential method is based on Wald's Sequential Probability
Ratio Test (SPRT) (\cite{wald45}).
Harold Kaplan pointed out this method on a website that no longer exists.
A derivation of this ``Kaplan-Wald'' method is given in Appendix A of~\cite{starkTeague14};
to apply the method here, take $t = \lambda_s$ in their equation~18.

A different sequential method, the Kaplan-Markov method (also due to Harold Kaplan), 
is given in~\cite{stark09b}.




\section{Ballot-polling derivation}\label{sec:appendix-polling}
\subsection{Conditional tri-hypergeometric test}

We consider a single stratum $s$, containing $N_s$ ballots.
Of the $N_s$ ballots,
$A_{w,s}$ have a vote for $w$ but not for $\ell$, $A_{\ell,s}$ have a vote for $\ell$ but not for $w$, and $A_{u,s} = N_s - N_{w,s} - N_{\ell,s}$ have votes for both $w$ and $\ell$ or neither $w$ nor $\ell$, including undervotes and invalid ballots.
We might draw a simple random sample of $n$ ballots ($n$ fixed ahead of time), or we might draw 
sequentially without replacement, so the sample size $B$ could be random.
For instance, the rule for determining $B$ could depend on the data.\footnote{%
   Sampling with replacement leads to simpler arithmetic, but is not as efficient.
}

Regardless, we assume that, conditional on the attained sample size $n$, the ballots are a simple random sample of size $n$ from the $N_s$ ballots in the population.
In the sample, $B_w$ ballots contain a vote for $w$ but not $\ell$, with $B_\ell$ and $B_u$ defined analogously.
The conditional joint distribution of
$(B_w, B_\ell, B_u)$ is tri-hypergeometric: 

\begin{equation}
    \mathbb{P}_{A_{w,s}, A_{\ell,s}} \{ B_w = i, B_\ell = j \vert B=n \} = 
     \frac{ {A_{w,s } \choose i}{A_{\ell,s} \choose j}{N_s - A_{w,s} - A_{\ell,s} \choose n-i-j}}{{N_s \choose n}}.
\end{equation}

Define the diluted sample margin, $D \equiv (B_w - B_\ell)/B$.
We want to test the compound hypothesis $A_{w,s} - A_{\ell,s} \le c$.
The value of $c$ is inferred from the definition
$\omega_{w\ell,s} \equiv V_{w\ell,s} - A_{w\ell,s} = V_{w,s} - V_{\ell,s} - (A_{w,s} -A_{\ell,s})$.
Thus,

\beq
    c = V_{w,s} - V_{\ell,s} - \omega_{w\ell,s} = V_{w\ell,s} - \lambda_s V_{w\ell}.
\eeq

The alternative is the compound hypothesis 
$A_{w,s} - A_{\ell,s} > c$.\footnote{%
    To use Wald's Sequential Probability Ratio Test, we might pick a simple alternative instead, e.g.,
   $A_{w,s} = V_{w,s}$ and $A_{\ell,s} = V_{\ell,s}$, the reported values, provided 
   $V_{w,s} - V_{\ell,s} > c$.
}
Hence, we will reject for large values of $D$.
Conditional on $B=n$, the event $D = (B_w - B_\ell)/B = d$ is the same as $B_w - B_\ell = nd$.\footnote{%
In contrast, the BRAVO ballot-polling
method~\cite{lindemanEtal12}
conditions only on $B_w+B_\ell = m$.
}


The $P$-value of the simple hypothesis that there are $A_{w,s}$ ballots with
a vote for $w$ but not for $\ell$, $A_{\ell,s}$ ballots with a vote for $\ell$ but not for $w$, 
and $N - A_{w,s} - A_{\ell,s}$ ballots with votes for both $w$ and $\ell$ or neither $w$ nor $\ell$ 
(including undervotes and
invalid ballots) is the probability that $B_w - B_\ell \geq nd$.
Therefore,

\begin{equation}
   \mathbb{P}_{A_{w,s}, A_{\ell,s}, N_s} \left \{ D \geq d \;\vert\; B = n\right \} = 
   \sum_{\substack{(i, j) :  i, j\ge 0 \\ i-j \geq nd \\ i+j \leq n}} \frac{ {A_{w,s } \choose i}{A_{\ell,s} \choose j}{N_s - A_{w,s} - A_{\ell,s} \choose n-i-j}}{{N_s \choose n}}.
\end{equation}



\subsection{Maximizing the $P$-value over the nuisance parameter}

The composite null hypothesis does not specify $A_{w,s}$ or $A_{\ell,s}$ separately, only 
that $A_{w,s} - A_{\ell,s} \le c$ for
some fixed, known $c$.
Define $\mathcal{S}$ to be the set of pairs $(i, j)$ such that $i, j\ge 0, i-j \ge nd,$ and $ i+j \leq n$.
The (conditional) $P$-value of this composite hypothesis for $D=d$ is the maximum $P$-value for all
values $(A_{w,s}, A_{\ell,s})$ that are possible under the null hypothesis,
\begin{equation}
  \max_{A_{w,s}, A_{\ell,s} \in \{0, 1, \ldots, N \}: A_{w,s} - A_{\ell,s} \le c, A_{w,s} + A_{\ell,s} \le N_s}
   \sum_{\substack{(i, j)\in \mathcal{S}}} \frac{ {A_{w,s } \choose i}{A_{\ell,s} \choose j}{N_s - A_{w,s} - A_{\ell,s} \choose n-i-j}}{{N_s \choose n}},
\end{equation}
wherever the summand is defined. 
(Equivalently, define ${m \choose k} \equiv 0$ if $k > m$, $k < 0$, or $m \le 0$.)

\subsubsection{Characterizing the optimal solution}
The following result enables us to only test hypotheses along the boundary of the null set.

\begin{thm}
Assume that $n < A_{w,s}+A_{\ell,s}$.
Suppose the composite null hypothesis is $N_w - N_\ell \leq c$.
The $P$-value is maximized on the boundary of the null region, i.e. when $N_w - N_\ell = c$.
\end{thm}

\begin{proof}
Without loss of generality, let $c=0$ and assume that $A_{u,s}=N_s - A_{w,s} - A_{\ell,s}$ is fixed.
Let $N_{w\ell, s} \equiv A_{w,s}+A_{\ell,s}$ be the fixed, unknown number of ballots for $w$ or for $\ell$ in stratum $s$.
The $P$-value $p_0$ for the simple hypothesis that $c=0$ is

\begin{equation}
  p_0 = \sum_{\substack{(i, j) \in \mathcal{S}}} \frac{ {N_{w\ell, s}/2 \choose i}{N_{w\ell, s}/2 \choose j}{A_{u,s} \choose n-i-j}}{{N_s \choose n}} =  \sum_{\substack{(i, j) \in \mathcal{S}}}T_{ij},
\end{equation}

\noindent where $T_{ij}$ is defined as the $(i, j)$ term in the summand and $T_{ij} \equiv 0$ for pairs $(i, j)$ that don't appear in the summation.

Assume that $c>0$ is given.
The $P$-value $p_c$ for this simple hypothesis is
\begin{align*}
p_c &=   \sum_{\substack{(i, j) \in \mathcal{S}}}  \frac{ {(N_{w\ell, s}+c)/2 \choose i}{(N_{w\ell, s}-c)/2 \choose j}{A_{u,s} \choose n-i-j}}{{N_s \choose n}}  \\
   &=\sum_{\substack{(i, j) \in \mathcal{S}}} T_{ij} \frac{ \frac{N_{w\ell, s}+c}{2}(\frac{N_{w\ell, s}+c}{2}-1)\cdots(\frac{N_{w\ell, s}}{2}+1) (\frac{N_{w\ell, s}-c}{2} -j)\cdots(\frac{N_{w\ell, s}}{2}-1-j) }
   {(\frac{N_{w\ell, s}+c}{2} -i)\cdots(\frac{N_{w\ell, s}}{2}+1-i)(\frac{N_{w\ell, s}-c}{2})\cdots(\frac{N_{w\ell, s}}{2}-1)}.
\end{align*}

Terms in the fraction can be simplified: choose the corresponding pairs in the numerator and denominator.
Fractions of the form $\frac{\frac{N_{w\ell, s}}{2} + a}{\frac{N_{w\ell,s}}{2} + a - i}$ can be expressed as $1 + \frac{i}{\frac{N_{w\ell,s}}{2} + a-i}$.
Fractions of the form $\frac{\frac{N_{w\ell, s}}{2}  - a - j}{\frac{N_{w\ell, s}}{2}  - a}$ can be expressed as $1 - \frac{j}{\frac{N_{w\ell, s}}{2} -a}$.
Thus, the $P$-value can be written as 

\begin{align*}
p_c &= \sum_{\substack{(i, j) \in \mathcal{S}}} T_{ij} \prod_{a=1}^{c/2} \left(1 + \frac{i}{\frac{N_{w\ell,s}}{2} + a-i}\right)\left(1 - \frac{j}{\frac{N_{w\ell, s}}{2} - a}\right) \\
&> \sum_{\substack{(i, j) \in \mathcal{S}}}  T_{ij} \left[ \left(1 + \frac{i}{\frac{N_{w\ell,s}+c}{2} -i}\right)\left(1 - \frac{j}{\frac{N_{w\ell, s}}{2}+1}\right) \right]^{c/2} \\
&= \sum_{\substack{(i, j) \in \mathcal{S}}} T_{ij} \left[ 1 + \frac{\frac{N_{w\ell,s}+c}{2}j + \frac{N_{w\ell,s}}{2}i + i}{(\frac{N_{w\ell,s}+c}{2}-i)(\frac{N_{w\ell,s}}{2}+1)}\right]^{c/2} \\
&> \sum_{\substack{(i, j) \in \mathcal{S}}}  T_{ij}\\
&= p_0
\end{align*}

The last inequality follows from the fact that $i$ and $j$ are nonnegative, and 
that $i < \frac{N_{w\ell,s}+c}{2}$ (it is a possible outcome under the null hypothesis).


\end{proof}

\subsubsection{Solving the optimization problem}

We have found empirically (but have not proven) that given $N$, $c$, and the observed sample values $B_w$ and $B_\ell$, the tail probability $p_c$, as a function of $A_{w,s}$,
has a unique maximum at one of the endpoints, where $A_{w,s}$ is either as small or as large as possible.
If this empirical result is true in general, then finding the maximum is trivial;
otherwise, computing the unconditional $P$-value is a simple 1-dimensional optimization problem
on a bounded interval.

\subsection{Conditional testing}
If the conditional tests are always conducted at significance level $\alpha$ or less, so that
$\mathbb{P} \{\mbox{Type I error} | B = n\} \le \alpha$, then the
overall procedure has significance level $\alpha$ or less:
\begin{eqnarray}
    \mathbb{P} \{\mbox{Type I error}\} &=& \sum_{n=0}^N  \mathbb{P}\{\mbox{Type I error} |  B = n\} \mathbb{P} \{ B = n \} \nonumber \\
       & \le & \sum_{n=0}^N \alpha \mathbb{P} \{  B = n \}  =  \alpha.
\end{eqnarray}

In particular, this implies that our conditional hypergeometric test will have a conservative $P$-value unconditionally.




\bibliography{./pbsBib}



\end{document}
